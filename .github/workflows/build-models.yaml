name: Build Model Containers

on:
  push:
    branches: [main]
    paths:
      - "models.json"
      - "Dockerfile"
      - ".github/workflows/build-models.yaml"
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all models (ignore existing images)"
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  NAMESPACE: ${{ github.repository }}

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      models: ${{ steps.check-models.outputs.models }}
      has-models: ${{ steps.check-models.outputs.has-models }}
    permissions:
      contents: read
      packages: read
    
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check which models need building
        id: check-models
        run: |
          echo "üîç Discovering models that need building..."
          
          # Read all models from models.json
          ALL_MODELS=$(cat models.json | jq -c '.models[]')
          MODELS_TO_BUILD=()
          
          # Check which models need building
          while IFS= read -r model_data; do
            model_name=$(echo "$model_data" | jq -r '.name')
            model_repo=$(echo "$model_data" | jq -r '.repo')
            
            image_tag="${{ env.REGISTRY }}/${{ env.NAMESPACE }}:$model_name"
            
            # Force rebuild or check existing
            if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
              echo "üîÑ Force rebuild: Will build $model_name"
              MODELS_TO_BUILD+=("$model_data")
            else
              echo -n "üîç Checking if $model_name exists... "
              if docker manifest inspect "$image_tag" >/dev/null 2>&1; then
                echo "‚úì exists, skipping"
              else
                echo "‚úó not found, will build"
                MODELS_TO_BUILD+=("$model_data")
              fi
            fi
          done <<< "$ALL_MODELS"
          
          # Create JSON array for matrix
          if [ ${#MODELS_TO_BUILD[@]} -eq 0 ]; then
            echo "üéâ No models need building"
            echo "models=[]" >> $GITHUB_OUTPUT
            echo "has-models=false" >> $GITHUB_OUTPUT
          else
            echo "üèóÔ∏è  Found ${#MODELS_TO_BUILD[@]} models to build"
            # Convert bash array to JSON array
            models_json="["
            for i in "${!MODELS_TO_BUILD[@]}"; do
              if [ $i -gt 0 ]; then
                models_json+=","
              fi
              models_json+="${MODELS_TO_BUILD[$i]}"
            done
            models_json+="]"
            
            echo "models=$models_json" >> $GITHUB_OUTPUT
            echo "has-models=true" >> $GITHUB_OUTPUT
          fi

  build:
    needs: discover
    if: needs.discover.outputs.has-models == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    strategy:
      fail-fast: false
      matrix:
        model: ${{ fromJson(needs.discover.outputs.models) }}
        
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push model
        run: |
          MODEL_NAME="${{ matrix.model.name }}"
          MODEL_REPO="${{ matrix.model.repo }}"
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.NAMESPACE }}:$MODEL_NAME"
          
          echo "üèóÔ∏è  Building $MODEL_NAME..."
          echo "üì¶ From repo: $MODEL_REPO"
          echo "üè∑Ô∏è  Image tag: $IMAGE_TAG"
          
          # Build args
          BUILD_ARGS=(
            "build"
            "-f" "Dockerfile"
            "-t" "$IMAGE_TAG"
            "--build-arg" "MODEL_REPO=$MODEL_REPO"
            "--build-arg" "MODEL_NAME=$MODEL_NAME"
            "--platform" "linux/amd64,linux/arm64"
            "--cache-from" "type=gha,scope=$MODEL_NAME"
            "--cache-to" "type=gha,mode=max,scope=$MODEL_NAME"
          )
          
          # Add HF token if provided
          if [ -n "${{ secrets.HF_TOKEN }}" ]; then
            BUILD_ARGS+=("--build-arg" "HF_TOKEN=${{ secrets.HF_TOKEN }}")
          fi
          
          # Only push on main branch commits and manual dispatch
          if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_ARGS+=("--push")
            echo "üöÄ Will push to registry"
          else
            echo "üî® Building without push"
          fi
          
          BUILD_ARGS+=(".")
          
          echo "Executing: docker buildx ${BUILD_ARGS[*]}"
          
          if docker buildx "${BUILD_ARGS[@]}"; then
            echo "‚úÖ Successfully built $MODEL_NAME"
          else
            echo "‚ùå Failed to build $MODEL_NAME"
            exit 1
          fi
